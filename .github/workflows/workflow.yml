name: Python Package CI/CD

on: [push, pull_request]

env:
  PYTHON_MIN: "3.8"
  PYTHON_MAX: "3.13" # renovate: datasource=python-version depName=python versioning=python

jobs:
  python-matrix:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.matrix.outputs.versions }}
    steps:
    - id: matrix
      run: |
        python3 - <<'PY'
        import json
        import os

        min_version = os.environ["PYTHON_MIN"]
        max_version = os.environ["PYTHON_MAX"]

        min_major, min_minor = map(int, min_version.split("."))
        max_major, max_minor = map(int, max_version.split("."))
        if min_major != max_major:
            raise ValueError("PYTHON_MIN and PYTHON_MAX must share major version")
        if min_minor > max_minor:
            raise ValueError("PYTHON_MIN must be <= PYTHON_MAX")

        versions = [f"{min_major}.{minor}" for minor in range(min_minor, max_minor + 1)]
        with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
            fh.write(f"versions={json.dumps(versions)}\n")
        PY

  build:
    needs: python-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ${{ fromJson(needs.python-matrix.outputs.versions) }}
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build

    - name: Build package
      run: python -m build

    - name: Upload build artifacts
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: dist-packages-${{ matrix.python-version }}
        path: dist/

  test:
    needs: [python-matrix, build]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJson(needs.python-matrix.outputs.versions) }}
        dependency-resolution: ["lowest-direct", "highest"]
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set up uv
      uses: astral-sh/setup-uv@v3

    - name: Download build artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
      with:
        name: dist-packages-${{ matrix.python-version }}
        path: dist/

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install "tomli; python_version < '3.11'"
        python - <<'PY'
        try:
            import tomllib
        except ModuleNotFoundError:  # Python < 3.11
            import tomli as tomllib
        from pathlib import Path

        deps = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))["project"]["dependencies"]
        Path("runtime-requirements.txt").write_text("\n".join(deps) + "\n", encoding="utf-8")
        print("Wrote runtime-requirements.txt with", len(deps), "dependencies")
        PY
        WHEEL_PATH="$(ls dist/*.whl | head -n 1)"
        uv pip install --python "$(which python)" --resolution "${{ matrix.dependency-resolution }}" -r runtime-requirements.txt
        uv pip install --python "$(which python)" --no-deps "$WHEEL_PATH"

    - name: Show resolved runtime versions
      run: |
        python - <<'PY'
        import importlib
        pkgs = ["h5py", "matplotlib", "numpy", "f90nml", "dask"]
        for pkg in pkgs:
            mod = importlib.import_module(pkg)
            print(f"{pkg}=={getattr(mod, '__version__', 'n/a')}")
        PY

    - name: Smoke import
      run: python -c "import dhybridrpy; print(dhybridrpy.__all__)"

    - name: Install notebook tooling
      if: matrix.dependency-resolution == 'highest'
      run: uv pip install --python "$(which python)" "ipython>=8,<10" "nbconvert>=7,<8"

    - name: Run example notebook
      if: matrix.dependency-resolution == 'highest'
      run: |
        cd examples
        ipython examples.ipynb

  publish:
    needs: [build, test]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: ${{ env.PYTHON_MAX }}

    - name: Download all build artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
      with:
        pattern: dist-packages-*
        path: dist/
        merge-multiple: true

    - name: Publish package to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
